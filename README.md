# ArgoCD Demo

- [ArgoCD Demo](#argocd-demo)
  - [Start A Minikube Cluster](#start-a-minikube-cluster)
  - [Install ArgoCD On Cluster](#install-argocd-on-cluster)
  - [Access ArgoCD UI](#access-argocd-ui)
  - [Login To ArgoCD UI](#login-to-argocd-ui)
  - [Configure ArgoCD](#configure-argocd)

## Start A Minikube Cluster

Start new Minikube cluster
```shell
minikube start
``` 

Get cluster status
```shell
minikube status
``` 

## Install ArgoCD On Cluster

[ArgoCD quick start documentation](https://argo-cd.readthedocs.io/en/stable/getting_started/#:~:text=1.-,Install%20Argo%20CD,-%C2%B6)

Create new namespace for ArgoCD deployment
```shell
kubectl create namespace argocd
``` 

Apply ArgoCD manifests to namespace
```shell
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
``` 

Wait for all pods to be in a running state
```text
❯ kubectl get pods -n argocd -w
NAME                                                READY   STATUS    RESTARTS   AGE
argocd-application-controller-0                     1/1     Running   0          7m34s
argocd-applicationset-controller-7b4f85b695-q785q   1/1     Running   0          7m34s
argocd-dex-server-6f9c68d695-jghx8                  1/1     Running   0          7m34s
argocd-notifications-controller-dc784d77f-sxfkh     1/1     Running   0          7m34s
argocd-redis-f4cdbff57-t78jh                        1/1     Running   0          7m34s
argocd-repo-server-596cb6c7fb-bn75v                 1/1     Running   0          7m34s
argocd-server-7f88f8b86b-tnfn5                      1/1     Running   0          7m34s
```

## Access ArgoCD UI

[Access The Argo CD API Server](https://argo-cd.readthedocs.io/en/stable/getting_started/#:~:text=3.-,Access%20The%20Argo%20CD%20API%20Server,-%C2%B6)

Access ArgoCD UI server using port forwarding
```text
❯ kubectl get svc -n argocd
NAME                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
argocd-applicationset-controller          ClusterIP   10.103.125.188   <none>        7000/TCP,8080/TCP            11m
argocd-dex-server                         ClusterIP   10.106.34.249    <none>        5556/TCP,5557/TCP,5558/TCP   11m
argocd-metrics                            ClusterIP   10.96.51.100     <none>        8082/TCP                     11m
argocd-notifications-controller-metrics   ClusterIP   10.111.68.160    <none>        9001/TCP                     11m
argocd-redis                              ClusterIP   10.99.176.117    <none>        6379/TCP                     11m
argocd-repo-server                        ClusterIP   10.101.194.7     <none>        8081/TCP,8084/TCP            11m
argocd-server                             ClusterIP   10.100.97.56     <none>        80/TCP,443/TCP               11m
argocd-server-metrics                     ClusterIP   10.111.213.230   <none>        8083/TCP                     11m
```
```shell
kubectl port-forward svc/argocd-server -n argocd 8080:443
```

Visit the following URL (ignore https warning and proceed anyway)
```text
127.0.0.1:8080
```

## Login To ArgoCD UI

[Login Using The CLI](https://argo-cd.readthedocs.io/en/stable/getting_started/#:~:text=4.-,Login%20Using%20The%20CLI,-%C2%B6)

The standard username is *admin*

The password gets autogenerated and saved in a secret called *argocd-initial-admin-secret*

In order to extract the secret run
```shell
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo
```

## Configure ArgoCD

[ArgoCD declarative setup documentation](https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/)

[Attribute documentation of the Application resource](https://argo-cd.readthedocs.io/en/stable/operator-manual/application.yaml)

A configuration file must be created in order to connect ArgoCD to the GIT repository where the system configuration files are hosted

Create a k8s resource of type application
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
    name: argocd-demo-app
    namespace: argocd
spec:
```

Add a project specification to group multiple applications into a project 
```yaml 
    project: default
```

Connect to a GIT repository (the source of truth)
```yaml
    source:
        repoURL: https://github.com/IlonaShishov/ArgoCD-demo.git  # Can point to either a Helm chart repo or a git repo.
        targetRevision: HEAD # Git revision specification. For Helm, this refers to the chart version.
        path: app # Specifies the directory inside the GIT repository in which the configuration files reside. This has no meaning for Helm charts pulled directly from a Helm repo instead of git.
```

Specify the destination of the API server which is the address of the k8s cluster itself
```yaml
destination:
        server: https://kubernetes.default.svc
        namespace: myapp # Specifies the namespace in which the configuration will be created. The namespace will only be set for namespace-scoped resources that have not set a value for .metadata.namespace
```

By default, the sync configurations are set to false, in order to take advantage of ArgoCD's sync capabilities we must specifically configure them
```yaml
    syncPolicy:
        syncOptions: # Sync options which modifies sync behavior
        - CreateNamespace=true # Namespace Auto-Creation ensures that namespace specified as the application destination exists in the destination cluster
        automated:
            selfHeal: true # Specifies if sync should be executed when resources are changed in target k8s cluster and no git change detected
            prune: true # Specifies if resources should be pruned during auto-syncing
```

Apply application.yaml to k8s cluster
```shell
kubectl apply -f argocd-config/application.yaml
```